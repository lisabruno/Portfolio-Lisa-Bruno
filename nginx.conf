# Configuration Nginx pour optimisation du portfolio
# Remplacer le contenu de votre bloc server dans nginx.conf

server {
    listen 80;
    listen [::]:80;
    server_name lisabruno-portfolio.com www.lisabruno-portfolio.com;
    root /var/www/portfolio;
    index index.html;

    # ============================================================
    # Redirection HTTPS
    # ============================================================
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name lisabruno-portfolio.com www.lisabruno-portfolio.com;
    root /var/www/portfolio;
    index index.html;

    # ============================================================
    # SSL Configuration (avec Let's Encrypt)
    # ============================================================
    ssl_certificate /etc/letsencrypt/live/lisabruno-portfolio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lisabruno-portfolio.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # ============================================================
    # Compression GZIP
    # ============================================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/json 
        application/javascript 
        application/xml+rss 
        application/rss+xml 
        font/truetype 
        font/opentype 
        application/vnd.ms-fontobject 
        image/svg+xml;
    gzip_disable "msie6";

    # ============================================================
    # Cache Headers
    # ============================================================
    
    # Fichiers statiques - cache long terme
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|otf|eot)$ {
        expires 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # HTML - cache court
    location ~* \.html$ {
        expires 1d;
        add_header Cache-Control "public, max-age=86400, must-revalidate";
    }

    # Par défaut
    expires 1h;
    add_header Cache-Control "public, max-age=3600";

    # ============================================================
    # Headers de sécurité
    # ============================================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

    # ============================================================
    # Sitemaps et robots.txt
    # ============================================================
    location ~ ^/(sitemap\.xml|robots\.txt|favicon\.ico)$ {
        expires 1d;
        access_log off;
    }

    # ============================================================
    # Refuser l'accès aux répertoires sensibles
    # ============================================================
    location ~ /médias/ {
        deny all;
        return 403;
    }

    location ~ /Animations/ {
        deny all;
        return 403;
    }

    # ============================================================
    # Réécriture d'URLs (optionnel - supprimer .html)
    # ============================================================
    # Si vous voulez /animation au lieu de /animation.html
    # location / {
    #     try_files $uri $uri/ $uri.html =404;
    # }

    # ============================================================
    # Gestion des erreurs
    # ============================================================
    error_page 404 /index.html;
    error_page 500 502 503 504 /error.html;
    location = /error.html {
        internal;
    }

    # ============================================================
    # Logs
    # ============================================================
    access_log /var/log/nginx/portfolio.access.log combined buffer=32k flush=5s;
    error_log /var/log/nginx/portfolio.error.log warn;
}

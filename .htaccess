# ============================================================
# Optimisation Apache - Compression et Cache
# ============================================================

# Activer les modules Apache requis
<IfModule mod_rewrite.c>
	RewriteEngine On
	RewriteBase /
</IfModule>

# ============================================================
# COMPRESSION GZIP
# ============================================================
<IfModule mod_deflate.c>
	# Compresse le texte, HTML, XML, CSS, et JavaScript
	AddOutputFilterByType DEFLATE text/plain
	AddOutputFilterByType DEFLATE text/html
	AddOutputFilterByType DEFLATE text/xml
	AddOutputFilterByType DEFLATE text/css
	AddOutputFilterByType DEFLATE text/javascript
	AddOutputFilterByType DEFLATE application/xml
	AddOutputFilterByType DEFLATE application/xhtml+xml
	AddOutputFilterByType DEFLATE application/rss+xml
	AddOutputFilterByType DEFLATE application/javascript
	AddOutputFilterByType DEFLATE application/x-javascript
	AddOutputFilterByType DEFLATE application/json
	
	# Exclure les images (déjà compressées)
	SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|svg)$ no-gzip dont-vary
	SetEnvIfNoCase Request_URI \.woff2$ no-gzip dont-vary
	
	# Ajouter le header Vary
	Header append Vary Accept-Encoding env=!dont-vary
</IfModule>

# ============================================================
# CACHE BROWSER (Expires Headers)
# ============================================================
<IfModule mod_expires.c>
	ExpiresActive On
	ExpiresDefault "access plus 2 days"
	
	# Images
	ExpiresByType image/jpeg "access plus 1 year"
	ExpiresByType image/gif "access plus 1 year"
	ExpiresByType image/png "access plus 1 year"
	ExpiresByType image/webp "access plus 1 year"
	ExpiresByType image/svg+xml "access plus 1 year"
	
	# CSS et JavaScript
	ExpiresByType text/css "access plus 1 month"
	ExpiresByType application/javascript "access plus 1 month"
	ExpiresByType text/javascript "access plus 1 month"
	
	# Fonts
	ExpiresByType font/ttf "access plus 1 year"
	ExpiresByType font/otf "access plus 1 year"
	ExpiresByType font/woff "access plus 1 year"
	ExpiresByType font/woff2 "access plus 1 year"
	ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
	
	# Documents HTML (pas de cache long)
	ExpiresByType text/html "access plus 1 day"
</IfModule>

# ============================================================
# CACHE CONTROL HEADERS
# ============================================================
<IfModule mod_headers.c>
	# Fichiers stables
	<FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|otf)$">
		Header set Cache-Control "public, max-age=31536000, immutable"
	</FilesMatch>
	
	# HTML (moins de cache)
	<FilesMatch "\.(html|htm)$">
		Header set Cache-Control "public, max-age=86400"
	</FilesMatch>
	
	# Fichiers par défaut
	Header set Cache-Control "public, max-age=3600"
	
	# Sécurité
	Header set X-Frame-Options "SAMEORIGIN"
	Header set X-Content-Type-Options "nosniff"
	Header set X-XSS-Protection "1; mode=block"
	Header set Referrer-Policy "no-referrer-when-downgrade"
</IfModule>

# ============================================================
# RÉÉCRITURE POUR URLs PROPRES (optionnel)
# ============================================================
<IfModule mod_rewrite.c>
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d
	# Supprimer .html des URLs (optionnel)
	# RewriteRule ^([^\.]+)$ $1.html [NC, L]
</IfModule>

# ============================================================
# DÉSACTIVER ETAGS (si pas supporté correctement)
# ============================================================
<IfModule mod_headers.c>
	Header unset ETag
	FileETag None
</IfModule>
